<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food App – Single File Demo</title>
  <style>
    /* CSS Reset */
    * {
      box-sizing: border-box;
    }

    :root {
      --primary: #4db6ac;
      --primary-dark: #319b91;
      --bg: #f6f9f9;
      --card: #ffffff;
      --text: #1d2b2a;
      --muted: #6b7c7b;
      --border: #e7efee;
      --success: #35b476;
      --warning: #ffb74d;
      --shadow: 0 10px 20px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      color: var(--text);
    }

    /* Phone frame */
    .stage {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .phone {
      width: 100%;
      max-width: 390px;
      min-height: 100vh;
      background: #ffffff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.15);
    }

    .phone-inner {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* App header */
    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: #e2f2f0;
      border-bottom: 1px solid var(--border);
    }

    .topbar .title {
      flex: 1;
      text-align: center;
      font-weight: 700;
    }

    .icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: #d8e9e7;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #3b5755;
    }

    .ghost {
      opacity: 0.35;
    }

    #backBtn.icon {
      background: transparent;
      border-radius: 0;
      width: auto;
      height: auto;
      font-size: 20px;
      padding: 0;
    }

    #backBtn {
      background: none;
      border: none;
      box-shadow: none;
      width: auto;
      height: auto;
      font-size: 20px;
      padding: 0;
      color: #3b5755;
    }


    /* Pages */
    .page {
      display: none;
      flex: 1;
      overflow: auto;
    }

    .page.active {
      display: block;
    }

    /* Common */
    .section {
      padding: 14px 16px;
    }

    .search {
      display: flex;
      align-items: center;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      gap: 8px;
    }

    .search input {
      border: 0;
      outline: 0;
      flex: 1;
      background: transparent;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      position: relative;
      cursor: pointer;
      transition: transform 0.15s;
    }

    .card:hover {
      transform: translateY(-1px);
    }

    .card.selected::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 20px;
      border: 2px solid var(--primary-dark);
      pointer-events: none;
    }

    .thumb {
      height: 56px;
      border-radius: 12px;
      background: #dfecea;
      margin-bottom: 8px;
    }

    .label {
      font-size: 12px;
      color: var(--muted);
    }

    .name {
      font-weight: 700;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: 0;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
      padding: 12px 18px;
      font-weight: 700;
      cursor: pointer;
    }

    .btn.full {
      width: 100%;
    }

    .btn.ghost {
      background: #dcefed;
      color: #1d2b2a;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .bottom-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg,
          rgba(246, 249, 249, 0),
          rgba(246, 249, 249, 1) 30%);
      padding: 12px 16px 16px;
    }

    /* Home lists */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
    }

    .row .pic {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: #dfecea;
    }

    .row .meta {
      flex: 1;
    }

    .price {
      font-weight: 800;
    }

    /* Detail */
    .hero {
      height: 160px;
      border-radius: 16px;
      background: #dfecea;
    }

    .pill {
      font-size: 11px;
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: #4b6260;
      background: #fff;
      margin-right: 6px;
    }

    .qty {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .counter {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px 10px;
      background: #fff;
    }

    .counter button {
      border: 0;
      background: #ecf6f5;
      border-radius: 8px;
      width: 26px;
      height: 26px;
      cursor: pointer;
    }

    /* Cart */
    .cart-line {
      display: grid;
      grid-template-columns: 48px 1fr auto auto;
      gap: 10px;
      align-items: center;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
    }

    .cart-line .xpic {
      width: 48px;
      height: 48px;
      background: #dfecea;
      border-radius: 10px;
    }

    .chip {
      font-size: 12px;
      color: #fff;
      background: var(--primary);
      padding: 3px 8px;
      border-radius: 999px;
    }

    table.kv {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    table.kv td {
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
    }

    table.kv tr:last-child td {
      border-bottom: 0;
    }

    /* Success */
    .success-mark {
      width: 140px;
      height: 140px;
      margin: 0 auto 16px;
      border-radius: 999px;
      background: #d9f1ed;
      display: grid;
      place-items: center;
    }

    .check {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 10px solid var(--success);
      position: relative;
    }

    .check:after {
      content: "";
      position: absolute;
      left: 14px;
      top: 16px;
      width: 24px;
      height: 44px;
      border-right: 10px solid var(--success);
      border-bottom: 10px solid var(--success);
      transform: rotate(40deg);
    }

    /* Simple tabbar (mock) */
    .tabbar {
      display: flex;
      justify-content: space-around;
      padding: 8px 12px;
      background: #fff;
      border-top: 1px solid var(--border);
    }

    .tab {
      display: grid;
      place-items: center;
      font-size: 12px;
      color: #4b6260;
    }

    /* === Override style Categories mirip mockup === */
    #page-categories .topbar {
      background: #dff4f1;
      /* header mint */
      border-bottom: 0;
    }

    #page-categories .topbar .title {
      font-weight: 800;
      font-size: 20px;
    }

    /* Search bar */
    #page-categories .search {
      background: #fff;
      border: 1px solid #dbe7e5;
      border-radius: 22px;
      padding: 12px 14px;
    }

    #page-categories .search input::placeholder {
      color: #9aa8a7;
    }

    /* Grid & card spacing */
    #page-categories .section {
      padding: 16px;
    }

    #page-categories .grid {
      gap: 16px;
    }

    /* Card mint */
    #page-categories .card {
      background: #e2f7f3;
      border: 0;
      border-radius: 18px;
      padding: 16px;
      box-shadow: none;
    }

    #page-categories .thumb {
      height: 64px;
      border-radius: 14px;
      background: #d9dedf;
      margin-bottom: 12px;
    }

    #page-categories .card .name {
      font-weight: 800;
      font-size: 16px;
      color: #253433;
    }

    #page-categories .card .label {
      font-size: 12px;
      color: #6b7c7b;
    }

    /* Selected outline */
    #page-categories .card.selected::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 22px;
      border: 2px solid #1fa18f;
    }

    /* Continue button */
    #continueBtn {
      height: 54px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 16px;
      background: linear-gradient(180deg, #2fb29f, #239e8d);
    }

    #continueBtn:disabled {
      opacity: 0.5;
    }

    /* Option Filter */
    .option-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      /* scroll horizontal */
      white-space: nowrap;
      /* biar item ga turun */
      padding-bottom: 20px;
      /* kasih ruang biar ga nempel */
      -webkit-overflow-scrolling: touch;
      /* smooth di mobile */
    }

    .filter-chip {
      padding: 6px 14px;
      border-radius: 999px;
      background: #e5e5e5;
      color: #777;
      font-size: 14px;
      white-space: nowrap;
      cursor: pointer;
    }

    .filter-chip.active {
      background: #d6f3ef;
      color: #27ae90;
      font-weight: 600;
    }

    .cart-summary {
      padding: 12px;
      border-radius: 12px;
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 14px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }

    .summary-row.subtotal span:first-child,
    .summary-row.total span:first-child {
      font-weight: bold;
      font-size: 15px;
    }

    .summary-row.total {
      color: #24a393;
      /* hijau untuk total */
      font-weight: bold;
    }

    .badge-free {
      background: #d8f5f0;
      color: #24a393;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
    }

    .payment-options {
      display: flex;
      gap: 12px;
    }

    .payment-card {
      width: 300px;
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 8px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-card img {
      width: 32px;
      height: 32px;
    }

    .payment-card span {
      font-size: 14px;
      font-weight: 500;
    }

    .payment-card.active {
      border-color: var(--primary);
      background: #d6f3ef;
    }

    .cart-icon {
      position: relative;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      background: #d8e9e7;
      border-radius: 8px;
    }

    #cartBadge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ff5a5f;
      color: #fff;
      font-size: 11px;
      border-radius: 50%;
      padding: 2px 5px;
      min-width: 18px;
      text-align: center;
      font-weight: bold;
    }

    #langSelect {
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="phone">
      <div class="phone-inner">
        <!-- HEADER (changes per page via JS) -->
        <div class="topbar">
          <button id="backBtn" class="icon" aria-label="back">⟵</button>
          <div id="headerTitle" class="title">Categories</div>
          <div id="cartIcon" class="cart-icon" data-go="page-cart">
            🛒 <span id="cartBadge">0</span>
          </div>
        </div>

        <div style="
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px;
            background: #e2f2f0;
            gap: 10px;
          ">
          <button id="orderHistoryBtn" class="btn ghost" style="padding:6px 12px;font-size:14px;color:#000;">
            📜 Order History
          </button>
          <select id="langSelect"
            style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:#fff;">
            <option value="en">English</option>
            <option value="zh-cn">简体中文</option>
            <option value="zh-tw">繁體中文</option>
            <option value="th">ภาษาไทย</option>
            <option value="id">Bahasa Indonesia</option>
            <option value="ms">Bahasa Melayu</option>
          </select>
          <button id="menuBtn"
            style="cursor:pointer;font-size:20px;line-height:1;background:none;border:none;">⋯</button>
        </div>
      </div>

      <!-- Popup login/register -->
      <div id="menuPopup" style="
          position: fixed;
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          background: #fff;
          border-top-left-radius: 20px;
          border-top-right-radius: 20px;
          box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
          padding: 20px 16px;
          width: 100%;
          max-width: 390px;
          display: none;
          z-index: 20;
        ">
        <div
          style="cursor:pointer;padding:12px 0;display:flex;align-items:center;gap:10px;font-size:16px;font-weight:600;border-bottom:1px solid #eee;"
          id="loginBtn">
          👤 Login/Register
        </div>
      </div>

      <!-- Modal Login/Register -->
      <div id="loginModal" style="
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 390px;
        height: 100%;
        background: rgba(0,0,0,0.45);
        display: none;
        z-index: 30;
        backdrop-filter: blur(2px);
        align-items: flex-end;
        justify-content: center;
      ">
        <div style="
          background: #fff;
          width: 100%;
          border-top-left-radius: 24px;
          border-top-right-radius: 24px;
          padding: 24px 20px;
          box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
          animation: slideUp 0.3s ease-out;
        ">

          <!-- LOGIN FORM -->
          <div id="loginForm">
            <div style="text-align: center; font-weight: 800; font-size: 20px; margin-bottom: 20px;">
              🔐 Login
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
              <input type="username" placeholder="Username" style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px;" />
              <input type="password" placeholder="Password" style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px;" />
              <button id="loginSubmit" class="btn full" style="margin-top: 8px;">Login</button>
              <button id="showRegister" class="btn ghost full">Create New Account</button>
            </div>
          </div>

          <!-- REGISTER FORM -->
          <div id="registerForm" style="display:none;">
            <div style="text-align: center; font-weight: 800; font-size: 20px; margin-bottom: 20px;">
              📝 Register
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
              <input type="text" placeholder="Full Name" style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px;" />
              <input type="email" placeholder="Email" style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px;" />
              <input type="password" placeholder="Password" style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px;" />
              <input type="password" placeholder="Confirm Password" style="padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px;" />
              <button id="registerSubmit" class="btn full" style="margin-top: 8px;">Register</button>
              <button id="showLogin" class="btn ghost full">← Back to Login</button>
            </div>
          </div>

          <div style="text-align:center;margin-top:16px;">
            <button id="closeLogin" style="background:none;border:none;color:#777;font-size:14px;cursor:pointer;">
              ✖ Close
            </button>
          </div>
        </div>
      </div>

      <!-- PAGES -->

      <!-- Select Categories -->
      <section id="page-categories" class="page active">
        <div class="section">
          <div class="search" style="margin-bottom: 12px">
            <input placeholder="Search Categories Food…" />
            <span class="icon">🔍</span>
          </div>
          <div class="grid" id="categoryGrid" style="margin-bottom: 14px"></div>
        </div>
      </section>

      <!-- Home -->
      <section id="page-home" class="page">
        <!-- Promo Card -->
        <div class="promo-card">
          <div class="promo-content">
            <div class="promo-text"></div>
          </div>
        </div>

        <div class="section">
          <div class="label" style="margin: 10px 0 6px">Menu</div>
          <div class="list" id="homePopular"></div>
        </div>
      </section>

      <!-- Detail Product -->
      <section id="page-detail" class="page">
        <div class="section">
          <div class="name" id="detailName" style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 4px;
                ">
            <span>Gudeg Assiap</span><span class="price" id="detailPrice">$20</span>
          </div>
          <br />
          <div class="label" id="detailDesc">
            Classic recipe from the latest innovation of the modern world…
          </div>
          <br />

          <!-- Lokasi & Favorite -->
          <div style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                ">
            <div id="detailLocation" style="
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    color: #888;
                  ">
            </div>
            <div style="color: teal; font-size: 18px"></div>
          </div>

          <!-- Hero / Gambar -->
          <div class="hero" style="
                  margin: 10px 0 8px;
                  background: #eee;
                  height: 200px;
                  border-radius: 12px;
                "></div>

          <!-- Rating & Waktu -->
          <div style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin: 8px 0;
                  color: #888;
                ">
            <div style="display: flex; align-items: center; gap: 4px">
            </div>
            <div style="display: flex; align-items: center; gap: 4px">
            </div>
          </div>

          <div class="option-section">
            <div class="option-title"></div>
            <div class="filter-chips" id="variantGroup"></div>
          </div>

          <div id="stockInfo" class="label" style="margin: 6px 0 12px; font-weight: bold;"></div>

          <div style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 10px;
                ">
            <div class="counter">
              <button id="minusBtn">–</button>
              <strong id="qtyNum">1</strong>
              <button id="plusBtn">+</button>
            </div>
            <button class="btn" id="addToCartBtn" style="flex: 1">
              Add to Cart
            </button>
          </div>
        </div>
      </section>

      <!-- Cart -->
      <section id="page-cart" class="page">
        <div class="section">
          <div id="cartList" class="list" style="margin-bottom: 10px"></div>
          <div class="card cart-summary">
            <div class="summary-row subtotal">
              <span>SUBTOTAL</span>
              <span id="cartSubtotal">$0</span>
            </div>
            <hr />
            <div class="summary-row">
              <span>Discount</span>
              <span id="cartDiscount">$0</span>
            </div>
            <div class="summary-row">
              <span>Delivery Charge</span>
              <span id="cartDelivery"><span class="badge-free">Free</span></span>
            </div>
            <div class="summary-row">
              <span>Taxes & Charge</span>
              <span id="cartTax">$0</span>
            </div>
            <hr />
            <div class="summary-row total">
              <span>TOTAL AMOUNT</span>
              <span id="cartTotal">$0</span>
            </div>
          </div>
        </div>
        <div class="bottom-bar">
          <div style="display: flex; gap: 10px; align-items: center">
            <button class="btn full" id="checkoutBtn">
              Checkout <span id="cartItemsCount">(0 Items)</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Checkout -->
      <section id="page-checkout" class="page">
        <div class="section">
          <!-- Daftar Produk di Checkout -->
          <div class="card" style="margin-bottom: 12px; padding: 16px; border-radius: 12px">
            <div style="font-weight:bold;margin-bottom:8px;">🛍️ Order Summary</div>
            <div id="checkoutProductList" class="list"></div>
          </div>
          <!-- Summary Harga -->
          <div class="card" style="margin-bottom: 12px; padding: 16px; border-radius: 12px">
            <div class="summary-row subtotal">
              <span>SUBTOTAL</span>
              <span id="chkSubtotal">$0</span>
            </div>
            <div class="summary-row">
              <span>Discount</span>
              <span id="chkDiscount">$0</span>
            </div>
            <div class="summary-row">
              <span>Delivery Charge</span>
              <span id="chkDelivery"><span class="badge-free">Free</span></span>
            </div>
            <div class="summary-row">
              <span>Taxes & Charge</span>
              <span id="chkTax">$2</span>
            </div>
            <hr />
            <div class="summary-row total">
              <span>TOTAL AMOUNT</span>
              <span id="chkTotal">$0</span>
            </div>
          </div>

          <!-- Delivery Option -->
          <div class="card" style="margin-bottom: 12px; padding: 16px; border-radius: 12px">
            <!-- Baris 1 -->
            <div style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 6px;
                    font-weight: bold;
                  ">
              <span>Delivery Option</span>
              <span style="font-size: 14px; color: #999"></span>
            </div>

            <!-- Baris 2 -->
            <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                  ">
              <div id="checkoutAddress" style="font-size: 14px">
                Blok 4, House No.47<br />
                Asamble Village,<br />
                Perempatan Sipucung
              </div>
              <a href="#" style="color: var(--primary); font-size: 14px"></a>
            </div>
          </div>

          <!-- Select Payment -->
          <div class="label" style="margin: 6px 0; font-weight: bold;">Select Payment</div>
          <div class="payment-options">
            <div class="payment-card active">
              <img src="icons/wallet.svg" alt="Dieting Pay">
              <span>Dieting Pay</span>
            </div>
            <div class="payment-card">
              <img src="icons/visa.svg" alt="Visa">
              <span>Visa</span>
            </div>
            <div class="payment-card">
              <img src="icons/mastercard.svg" alt="Mastercard">
              <span>Mastercard</span>
            </div>
            <div class="payment-card">
              <img src="icons/bank.svg" alt="Bank">
              <span>Bank</span>
            </div>
          </div>

          <!-- Tombol Payment -->
          <div class="bottom-bar">
            <button class="btn full" id="payBtn">Payment</button>
          </div>
        </div>
      </section>

      <!-- Success -->
      <section id="page-success" class="page">
        <div class="section" style="text-align: center">
          <div class="success-mark">
            <div class="check"></div>
          </div>
          <h2>Congratulations!</h2>
          <p class="label">"Congratulations! Your payment has been successful. Your order is being processed and will be
            sent soon. Thank you for using our application!"</p>
          <div class="card" style="margin-bottom: 12px; padding: 16px; border-radius: 12px">
            <div class="summary-row subtotal">
              <span>SUBTOTAL</span>
              <span id="sxSubtotal">$0</span>
            </div>
            <div class="summary-row">
              <span>Discount</span>
              <span id="sxDiscount">$0</span>
            </div>
            <div class="summary-row">
              <span>Delivery Charge</span>
              <span id="sxDelivery"><span class="badge-free">Free</span></span>
            </div>
            <div class="summary-row">
              <span>Taxes & Charge</span>
              <span id="sxTax">$2</span>
            </div>
            <hr />
            <div class="summary-row total">
              <span>TOTAL AMOUNT</span>
              <span id="sxTotal">$0</span>
            </div>
          </div>
        </div>
        <div class="bottom-bar">
          <button class="btn full" data-go="page-home">Back to Home</button>
        </div>
      </section>

      <!-- Order History -->
      <section id="page-orders" class="page">
        <div class="section">
          <h2 style="margin-bottom: 16px;">📦 Order History</h2>
          <div id="ordersList" class="list"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const ROOT_URL = "https://ecomdemo.syntheraco.com/dapi";
    const API_KEY = "9419919608a0bbe08786a97276d415c2";
    const _lang = "en";

    // --- Mock data ---
    const products = [
      {
        id: "dawet",
        name: "Dawet Ayu",
        price: 10,
        desc: "Javanese iced dessert with palm sugar and coconut milk.",
      },
      {
        id: "klepon",
        name: "Klepon Maknyus",
        price: 15,
        desc: "Sticky rice balls filled with palm sugar and coconut sprinkles.",
      },
      {
        id: "bakso",
        name: "Bakso Ya'Ke",
        price: 20,
        desc: "Beef meatball soup, hearty and savory.",
      },
      {
        id: "bajigur",
        name: "Bajigur Loncat",
        price: 12,
        desc: "Warm coconut milk drink with palm sugar and ginger.",
      },
    ];

    const cart = new Map(); // key -> {id,name,price,qty}

    // --- Helpers ---
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];

    function setHeader(title, showBack) {
      $("#headerTitle").textContent = title;
      $("#backBtn").style.visibility = showBack ? "visible" : "hidden";
    }

    function showPage(id) {
      $$(".page").forEach((p) => p.classList.remove("active"));
      const page = $("#" + id);
      page.classList.add("active");
      currentPage = id;
      // header titles
      const titles = {
        "page-categories": "Categories",
        "page-home": "Home",
        "page-detail": "Food Detail",
        "page-cart": "Cart",
        "page-checkout": "Checkout",
        "page-success": "Success",
        "page-orders": "Order History",
      };
      setHeader(titles[id] || "Food App", id !== "page-categories");
      historyStack.push(id);
    }

    document.querySelectorAll(".payment-card").forEach(card => {
      card.addEventListener("click", () => {
        document.querySelectorAll(".payment-card").forEach(c => c.classList.remove("active"));
        card.classList.add("active");
      });
    });

    document.querySelectorAll(".filter-chip").forEach((chip) => {
      chip.addEventListener("click", () => {
        // hapus active dari semua chip
        document
          .querySelectorAll(".filter-chip")
          .forEach((c) => c.classList.remove("active"));
        // tambahkan active ke chip yang diklik
        chip.classList.add("active");

        // kalau mau ambil value yang dipilih:
        const selectedOption = chip.textContent.trim();
        console.log("Selected:", selectedOption);

        // kalau mau filter data bisa panggil function filter disini
        // filterMenu(selectedOption);
      });
    });

    // Detail
    let currentDetail = null;
    let qty = 1;
    function updateQty() {
      $("#qtyNum").textContent = qty;
    }

    // Cart
    function upsertCart(p, q) {
      const key = `${p.id}-${p.variant || ""}-${p.spicy || ""}`;
      const row = cart.get(key) || {
        id: p.id,
        name: p.title || p.name || "Unnamed product",
        price: p.price,
        qty: 0,
        variant: p.variant || null,
        spicy: p.spicy || null,
        variations: p.variations || []
      };
      row.qty += q;
      if (row.qty <= 0) cart.delete(key);
      else cart.set(key, row);

      // 🆕 simpan ke localStorage setiap kali cart berubah
      localStorage.setItem("cart", JSON.stringify([...cart.values()]));
      
      renderCart();
    }

    function updateCartBadge() {
      const totalItems = [...cart.values()].reduce((sum, item) => sum + item.qty, 0);
      document.getElementById("cartBadge").textContent = totalItems;
    }

    function renderCart() {
      const list = $("#cartList");
      list.innerHTML = "";
      let subtotal = 0,
        count = 0;
      cart.forEach((item) => {
        subtotal += item.price * item.qty;
        count += item.qty;
        const line = document.createElement("div");
        line.className = "cart-line";
        line.innerHTML = `
          <div class="xpic"></div>
          <div>
            <div class="name">${item.name} 
              ${item.variations?.length ? " – " + item.variations.join(", ") : ""}
            </div>
            <div class="label">$${item.price} • each</div>
          </div>
          <div>
            <div class="price" style="justify-self:center; margin-bottom: 6px;">
              $${item.price * item.qty}
            </div>
            <div class="counter" style="justify-self:end">
              <button class="dec">–</button>
              <strong>${item.qty}</strong>
              <button class="inc">+</button>
            </div>
          </div>
        `;
        line.querySelector(".dec").addEventListener("click", () => {
          upsertCart(item, -1);
        });
        line.querySelector(".inc").addEventListener("click", () => {
          upsertCart(item, 1);
        });
        list.appendChild(line);
      });
      const discount = 0;
      const delivery = subtotal > 0 ? 0 : 0;
      const total = subtotal - discount + delivery;
      $("#cartSubtotal").textContent = `$${subtotal}`;
      $("#cartDiscount").textContent = `$${discount}`;
      $("#cartDelivery").textContent = delivery ? `$${delivery}` : "$0";
      $("#cartTotal").textContent = `$${total}`;
      $("#cartItemsCount").textContent = `(${count} Items)`;

      // mirror to checkout/success
      $("#chkSubtotal").textContent = `$${subtotal}`;
      $("#chkDiscount").textContent = `$${discount}`;
      $("#chkDelivery").textContent = "Free";
      $("#chkTax").textContent = "$2";
      $("#chkTotal").textContent = `$${total + 2}`;

      $("#sxSubtotal").textContent = `$${subtotal}`;
      $("#sxDiscount").textContent = `$${discount}`;
      $("#sxTax").textContent = "$2";
      $("#sxTotal").textContent = `$${total + 2}`;

      updateCartBadge();
    }

    // Navigation + events
    let currentPage = "page-categories";
    const historyStack = [];

    $("#backBtn").addEventListener("click", () => {
      // pop current
      historyStack.pop();
      const prev = historyStack.pop() || "page-categories";
      showPage(prev);
    });

    document.addEventListener("click", (e) => {
      const go = e.target.closest("[data-go]");
      if (go) {
        showPage(go.getAttribute("data-go"));
      }
    });

    $("#addToCartBtn").addEventListener("click", () => {
      if (!currentDetail) {
        alert("⚠️ Pilih varian terlebih dahulu sebelum menambahkan ke keranjang!");
        return;
      }

      console.log('add to cart', currentDetail, qty);
      upsertCart(currentDetail, qty);
    });

    $("#checkoutBtn").addEventListener("click", () => {
      checkout();
    });

    // init
    renderCart();

    // Categories selection logic
    (function () {
      const page = document.getElementById("page-categories");
      if (!page) return;
      const cards = Array.from(page.querySelectorAll(".card"));
      const search = page.querySelector(".search input");
      const selected = new Set();

      cards.forEach((card) => {
        card.addEventListener("click", () => {
          cards.forEach((c) => c.classList.remove("selected"));
          selected.clear();

          card.classList.add("selected");
          const name = card.querySelector(".name")?.textContent?.trim();
          if (name) {
          selected.add(name);
          showPage("page-home");
        }
        });
      });

      if (search) {
        search.addEventListener("input", (e) => {
          const q = e.target.value.toLowerCase().trim();
          cards.forEach((c) => {
            const name =
              c.querySelector(".name")?.textContent.toLowerCase() || "";
            c.style.display = name.includes(q) ? "" : "none";
          });
        });
      }
    })();

    setHeader("Categories", false);

    // === Change Language Feature ===
    const translations = {
      "en": {
        categories: "Categories",
        continue: "Continue",
        searchPlaceholder: "Search Categories Food…",
        promo: "70% discount on all traditional drink product",
        getNow: "Get Now",
        option: "Option",
        popular: "Popular Menu",
        favorite: "Favorite Menu",
        payment: "Payment",
        success: "Congratulations!",
      },
      "id": {
        categories: "Kategori",
        continue: "Lanjutkan",
        searchPlaceholder: "Cari Kategori Makanan…",
        promo: "Diskon 70% untuk semua produk minuman tradisional",
        getNow: "Dapatkan Sekarang",
        option: "Pilihan",
        popular: "Menu Populer",
        favorite: "Menu Favorit",
        payment: "Bayar",
        success: "Berhasil!",
      },
      "zh-cn": {
        categories: "类别",
        continue: "继续",
        searchPlaceholder: "搜索美食类别…",
        promo: "所有传统饮品享受七折优惠",
        getNow: "立即获取",
        option: "选项",
        popular: "热门菜单",
        favorite: "最爱菜单",
        payment: "支付",
        success: "恭喜您！",
      },
      "zh-tw": {
        categories: "類別",
        continue: "繼續",
        searchPlaceholder: "搜尋美食類別…",
        promo: "所有傳統飲品七折優惠",
        getNow: "立即獲取",
        option: "選項",
        popular: "熱門菜單",
        favorite: "最愛菜單",
        payment: "付款",
        success: "恭喜您！",
      },
      "th": {
        categories: "หมวดหมู่",
        continue: "ดำเนินการต่อ",
        searchPlaceholder: "ค้นหาหมวดหมู่อาหาร…",
        promo: "ลด 70% สำหรับเครื่องดื่มดั้งเดิมทั้งหมด",
        getNow: "รับเลย",
        option: "ตัวเลือก",
        popular: "เมนูยอดนิยม",
        favorite: "เมนูโปรด",
        payment: "ชำระเงิน",
        success: "ยินดีด้วย!",
      },
      "ms": {
        categories: "Kategori",
        continue: "Teruskan",
        searchPlaceholder: "Cari Kategori Makanan…",
        promo: "Diskaun 70% untuk semua produk minuman tradisional",
        getNow: "Dapatkan Sekarang",
        option: "Pilihan",
        popular: "Menu Popular",
        favorite: "Menu Kegemaran",
        payment: "Bayaran",
        success: "Tahniah!",
      }
    };

    function changeLanguage(lang) {
      const t = translations[lang] || translations["en"];
      $("#headerTitle").textContent = t.categories;
      $("#page-categories .search input").placeholder = t.searchPlaceholder;
      $("#payBtn").textContent = t.payment;
      $("#page-success h2").textContent = t.success;
    }

    document.getElementById("langSelect").addEventListener("change", (e) => {
      changeLanguage(e.target.value);
    });

    // default bahasa: English
    changeLanguage("en");

    // === MOCK ORDER HISTORY ===
    const orderHistory = [
      {
        id: "ORD-20250930-001",
        date: "2025-09-30",
        items: 3,
        total: 54,
        status: "Delivered",
      },
      {
        id: "ORD-20250925-004",
        date: "2025-09-25",
        items: 2,
        total: 32,
        status: "On the Way",
      },
      {
        id: "ORD-20250918-007",
        date: "2025-09-18",
        items: 4,
        total: 78,
        status: "Canceled",
      },
    ];

    function renderOrders() {
      const list = document.getElementById("ordersList");
      list.innerHTML = "";

      if (orderHistory.length === 0) {
        list.innerHTML = "<p class='label'>No orders found.</p>";
        return;
      }

      orderHistory.forEach(order => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.padding = "16px";
        card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-weight:bold;">${order.id}</div>
              <div style="font-size:13px;color:#777;">${order.date}</div>
            </div>
            <div style="margin:6px 0;color:#555;font-size:14px;">
              ${order.items} items • $${order.total}
            </div>
            <div style="font-weight:bold;color:${order.status === "Delivered" ? "#35b476" : order.status === "On the Way" ? "#ffb74d" : "#ff5a5f"};">
              ${order.status}
            </div>
          `;
        list.appendChild(card);
      });
    }

    document.getElementById("orderHistoryBtn").addEventListener("click", () => {
      renderOrders();
      showPage("page-orders");
    });

    // === Menu titik tiga popup ===
    const menuBtn = document.getElementById("menuBtn");
    const menuPopup = document.getElementById("menuPopup");

    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      menuPopup.style.display = menuPopup.style.display === "block" ? "none" : "block";
    });

    // Tutup popup jika klik di luar
    document.addEventListener("click", (e) => {
      if (!menuPopup.contains(e.target) && e.target !== menuBtn) {
        menuPopup.style.display = "none";
      }
    });
    
    // === Modal Login ===
    const loginModal = document.getElementById("loginModal");
    document.getElementById("loginBtn").addEventListener("click", () => {
      menuPopup.style.display = "none";
      loginModal.style.display = "flex";
    });

    document.getElementById("closeLogin").addEventListener("click", () => {
      loginModal.style.display = "none";
    });

    // (opsional) klik di luar modal menutupnya
    loginModal.addEventListener("click", (e) => {
      if (e.target === loginModal) loginModal.style.display = "none";
    });

    // === Toggle Login/Register ===
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    document.getElementById("showRegister").addEventListener("click", () => {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
    });
    document.getElementById("showLogin").addEventListener("click", () => {
      registerForm.style.display = "none";
      loginForm.style.display = "block";
    });

    // Dummy aksi submit register
    document.getElementById("registerSubmit").addEventListener("click", async () => {
      const name = document.querySelector('#registerForm input[placeholder="Full Name"]').value;
      const email = document.querySelector('#registerForm input[placeholder="Email"]').value;
      const password = document.querySelector('#registerForm input[placeholder="Password"]').value;
      const confirmPassword = document.querySelector('#registerForm input[placeholder="Confirm Password"]').value;

      if (password !== confirmPassword) {
        alert("❌ Password tidak cocok!");
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password }),
        });

        const data = await res.json();
        if (res.ok) {
          alert("✅ Register berhasil!");
          registerForm.style.display = "none";
          loginForm.style.display = "block";
        } else {
          alert("❌ Gagal register: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        alert("🚨 Error koneksi ke server!");
      }
    });

    document.getElementById("loginSubmit").addEventListener("click", async () => {
      const username = document.querySelector('#loginForm input[placeholder="Username"]').value;
      const password = document.querySelector('#loginForm input[placeholder="Password"]').value;
      
      const params = new URLSearchParams({
        ao: 1,
        app: 1,
        api_key: API_KEY,
        username: username,
        password: password,
        op: "login"
      });

      try {
        const res = await fetch(`${ROOT_URL}/open_api/?lang=${_lang}&${params.toString()}`, {
          method: "GET",
          headers: { "Accept": "application/json" }
        });

        const data = await res.json();

        if (data.status === 1) {
          const member_info = data.member_info;
          localStorage.setItem("member_id", member_info['id']);
          localStorage.setItem("session_mid", member_info['id']);
          localStorage.setItem("session_member_login_key", member_info['session_member_login_key']);
          localStorage.setItem("cookie_session_id", member_info['cookie_session_id']);
          localStorage.setItem("username", member_info['username']);
          localStorage.setItem("full_name", member_info['name']);
          _login_data_str = '&ao=1&session_mid=' + member_info['username'] + '&session_member_login_key=' + member_info['session_member_login_key'] + '&cookie_session_id=' + member_info['cookie_session_id'];
          _notification = member_info.enable_push_notification;
          localStorage.setItem("login_data_str", _login_data_str);

          // ✅ Ubah tombol jadi Logout
          const loginBtn = document.getElementById("loginBtn");
          loginBtn.textContent = "🚪 Logout";

          // Tutup modal login
          loginModal.style.display = "none";

          // ✅ Tambahkan event klik untuk logout
          loginBtn.onclick = () => {
            localStorage.clear();
            loginBtn.textContent = "👤 Login/Register";
            alert("✅ You was logged out.");
          };
        } else {
          alert("❌ Failed login: " + (data.error || "Invalid credentials"));
        }
      } catch (err) {
        alert("🚨 Server Error!");
      }
    });

    // ✅ Cek status login saat halaman pertama dimuat
    window.addEventListener("DOMContentLoaded", () => {
      const loginBtn = document.getElementById("loginBtn");

      if (localStorage.getItem("member_id")) {
        // Kalau ada data login di localStorage → tampilkan tombol Logout
        loginBtn.textContent = "🚪 Logout";
        loginBtn.onclick = () => {
          localStorage.clear();
          loginBtn.textContent = "👤 Login/Register";
          alert("✅ You was logged out.");
        };
      } else {
        // Kalau belum login → tampilkan tombol Login/Register
        loginBtn.textContent = "👤 Login/Register";
        loginBtn.onclick = () => {
          menuPopup.style.display = "none";
          loginModal.style.display = "flex";
        };
      }

      // ✅ Load cart dari localStorage
      const savedCart = JSON.parse(localStorage.getItem("cart") || "[]");
      if (savedCart.length > 0) {
        savedCart.forEach(item => {
          const key = `${item.id}-${item.variant || ""}-${item.spicy || ""}`;
          cart.set(key, item);
        });
        renderCart();
      }
      updateCartBadge();

      get_template_data();
    });

    async function get_template_data() {
      const params = new URLSearchParams({
        ao: 1,
        api_key: API_KEY,
        op: "get_template_data"
      });

      try {
        const res = await fetch(`${ROOT_URL}/open_api/?lang=${_lang}`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
        });

        const data = await res.json();

        if (data.status === 1) {
          build_category_menu(data.product_categories.category_tree);
        } else {
          alert("❌ API Error:", data.msg);
        }
      } catch (err) {
        console.log('err', err);
        alert("🚨 Server Error!", err);
      }
    }

    function build_category_menu(category_tree) {
      const grid = document.getElementById("categoryGrid");
      grid.innerHTML = "";

      if (!category_tree || Object.keys(category_tree).length === 0) {
        grid.innerHTML = "<p class='label'>No categories available</p>";
        return;
      }

      // 🔁 Loop kategori utama
      Object.values(category_tree).forEach(parent => {
        const parentCard = document.createElement("div");
        parentCard.className = "card";
        parentCard.innerHTML = `
          <div class="thumb"></div>
          <div class="name">${parent.category}</div>
          <div class="label">Main Category</div>
        `;
        parentCard.addEventListener("click", () => {
          _scids = [parent.id];
          _pg = 1;
          get_product_listing();
          showPage("page-home");
        });
        grid.appendChild(parentCard);

        if (parent.sub_cat && Object.keys(parent.sub_cat).length > 0) {
          Object.values(parent.sub_cat).forEach(sub => {
            const subCard = document.createElement("div");
            subCard.className = "card";
            subCard.style.marginLeft = "8px";
            subCard.innerHTML = `
              <div class="thumb"></div>
              <div class="name">${sub.category}</div>
              <div class="label">Sub Category</div>
            `;
            subCard.addEventListener("click", () => {
              _scids = [sub.id];
              _pg = 1;
              get_product_listing();
              showPage("page-home");
            });
            grid.appendChild(subCard);
          });
        }
      });
    }
    
    let _scids = [];
    let _pg = 1;
    let _smcid = '';
    let _shash = [];
    let _sortby = '';
    let _spricerange = '';
    let _skeyword = '';
    let _promolist = '';

    async function get_product_listing() {
      try {
        const res = await fetch(`${ROOT_URL}/open_api/?lang=${_lang}`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            ao: 1,
            op: "get_product_list",
            api_key: API_KEY,
            pg: _pg,
            smcid: _smcid,
            "scids[]": _scids,
            "shash[]": _shash,
            sortby: _sortby,
            spricerange: _spricerange,
            skeyword: _skeyword,
            promolist: _promolist,
          })
        });

        const data = await res.json();
        const target = document.getElementById("homePopular");
        target.innerHTML = "";

        if (data.status === 1 && data.data && Object.keys(data.data).length > 0) {
          Object.values(data.data).forEach(prod => {
            const card = document.createElement("div");
            card.className = "row";
            card.innerHTML = `
              <div class="pic" style="background-image:url(${prod.product_images?.[0]?.image_name_url || ''})"></div>
              <div class="meta">
                <div class="name">${prod['title_' + _lang]}</div>
                <div class="label">RM ${prod.product_prices}</div>
              </div>
            `;
            card.addEventListener("click", () => get_product_info(prod.id));
            target.appendChild(card);
          });
        } else {
          target.innerHTML = "<p class='label'>No products found.</p>";
        }
      } catch (err) {
        console.error(err);
        alert("🚨 Failed to load product list");
      }
    }

    async function get_product_info(pid) {
      try {
        const res = await fetch(`${ROOT_URL}/open_api/?lang=${_lang}`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            ao: 1,
            op: "get_product_by_id",
            api_key: API_KEY,
            pid: pid
          }),
        });

        const data = await res.json();
        if (data.status === 1 && data.data) {
          const prod = data.data;

          // 🧠 Isi field detail
          $("#detailName span").textContent = prod['title_' + _lang];
          $("#detailPrice").textContent = `RM ${prod.product_prices}`;
          $("#detailDesc").textContent = prod['description_' + _lang] || "-";

          // ❗️Matikan qty dan addToCart dulu sebelum varian dipilih
          $("#plusBtn").disabled = true;
          $("#minusBtn").disabled = true;
          $("#addToCartBtn").disabled = true;

          const hero = document.querySelector(".hero");
          hero.style.backgroundImage = `url(${prod.product_images?.[0]?.image_name_url || ''})`;
          hero.style.backgroundSize = "cover";
          hero.style.backgroundPosition = "center";

          // 🧪 Render opsi / varian
          const variantContainer = document.getElementById("variantGroup");
          variantContainer.innerHTML = "";
          let selectedVariants = {};

          // 🔍 Ambil dari level ROOT, bukan dari prod
          const variantNames = data.variant_names;
          const variantValues = data.variant_values;
          const variantList = data.variant_list;
          const variantsString = prod.variants;

          if (variantNames && variantValues && variantList) {
            Object.entries(variantNames).forEach(([variantId, variantName]) => {
              const section = document.createElement("div");
              section.className = "option-section";

              const title = document.createElement("div");
              title.className = "option-title";
              title.textContent = variantName;
              section.appendChild(title);

              const chips = document.createElement("div");
              chips.className = "filter-chips";

              Object.entries(variantValues).forEach(([valueId, valueLabel]) => {
                // Pastikan ID varian ini dipakai produk ini
                if (variantsString?.includes(`${variantId}:${valueId}`)) {
                  const chip = document.createElement("div");
                  chip.className = "filter-chip";
                  chip.textContent = valueLabel;
                  chip.dataset.variantId = variantId;
                  chip.dataset.valueId = valueId;

                  chip.addEventListener("click", () => {
                    chips.querySelectorAll(".filter-chip").forEach(c => c.classList.remove("active"));
                    chip.classList.add("active");

                    selectedVariants[variantId] = valueId;

                    // Semua varian sudah dipilih → update UI
                    if (Object.keys(selectedVariants).length === Object.keys(variantNames).length) {
                      const key = Object.values(selectedVariants).join("_"); // contoh: "5" atau "37_38"
                      const variantData = variantList[key];
                      if (variantData) {
                        // 🟢 Simpan data lengkap ke currentDetail
                        currentDetail = {
                          id: variantData.id, // ini variant ID!
                          pid: prod.id, // ini ID produk utama
                          title: variantData.title || prod['title_' + _lang],
                          image: prod.product_images?.[0]?.image_name_url || "",
                          price: parseFloat(variantData.price) || 0,
                          oldPrice: parseFloat(prod.old_price || 0),
                          discount: parseFloat(prod.discount || 0),
                          rating: 0,
                          variations: Object.values(selectedVariants).map(vId => variantValues[vId]).filter(Boolean),
                          variantId: variantData.id
                        };
                        
                        document.getElementById("detailPrice").textContent = `RM ${variantData.price}`;
                        document.querySelector("#detailName span").textContent = variantData.title || prod.title;

                        const stock = data.inventory?.[variantData.id] || "0";
                        window.maxStock = parseInt(stock);
                        const stockInfoEl = document.getElementById("stockInfo");
                        stockInfoEl.textContent = `Stock available: ${stock}`;
                        stockInfoEl.style.color = parseInt(stock) > 0 ? "green" : "red";

                        // ✅ Aktifkan tombol +, - , dan Add to Cart jika stok > 0
                        const hasStock = parseInt(stock) > 0;
                        $("#plusBtn").disabled = !hasStock;
                        $("#minusBtn").disabled = !hasStock;
                        $("#addToCartBtn").disabled = !hasStock;

                        // ✅ opsional: ubah tombol jika stok habis
                        const addToCartBtn = document.getElementById("addToCartBtn");
                        if (parseInt(stock) > 0) {
                          addToCartBtn.disabled = false;
                          addToCartBtn.textContent = "Add to Cart";
                        } else {
                          addToCartBtn.disabled = true;
                          addToCartBtn.textContent = "Out of Stock";
                        }
                      }
                    }
                  });

                  chips.appendChild(chip);
                }
              });

              section.appendChild(chips);
              variantContainer.appendChild(section);
            });
          } else {
            variantContainer.innerHTML = "<p class='label'>No variants available</p>";
          }

          showPage("page-detail");
        } else {
          alert("❌ Gagal ambil detail produk");
        }
      } catch (err) {
        console.error(err);
        alert("🚨 Gagal memuat detail produk");
      }
    }

    function updateQtyButtons() {
      const qty = parseInt(document.getElementById("qtyNum").textContent);
      const plusBtn = document.getElementById("plusBtn");
      const minusBtn = document.getElementById("minusBtn");
      const maxStock = window.maxStock ?? Infinity;

      plusBtn.disabled = qty >= maxStock;
      minusBtn.disabled = qty <= 1;
    }

    document.getElementById("plusBtn").addEventListener("click", () => {
      const maxStock = window.maxStock ?? Infinity;
      if (qty < maxStock) {
        qty++;
        updateQty();
      }
      updateQtyButtons();
    });

    document.getElementById("minusBtn").addEventListener("click", () => {
      if (qty > 1) {
        qty--;
        updateQty();
      }
      updateQtyButtons();
    });

    async function checkout() {
      const username = localStorage.getItem("username");
      const sessionMemberLoginKey = localStorage.getItem("session_member_login_key");
      const cookieSessionId = localStorage.getItem("cookie_session_id");

      if (!username || !sessionMemberLoginKey || !cookieSessionId) {
        alert("⚠️ Please login before checkout!");
        return;
      }

      const cartItems = [...cart.values()];
      if (cartItems.length === 0) {
        alert("🛒 Your cart is empty!");
        return;
      }

      // 🔁 daftar product ID yang dibeli
      const purchasedPids = cartItems.map(item => item.id);

      // 🔁 format newMyCart sesuai indeks
      const newMyCart = {};
      cartItems.forEach((item, i) => {
        newMyCart[i.toString()] = {
          id: item.id.toString(),
          quantity: item.qty.toString()
        };
      });

      try {
        const queryParams = new URLSearchParams({
          lang: _lang,
          ao: "1",
          session_mid: username,
          session_member_login_key: sessionMemberLoginKey,
          cookie_session_id: cookieSessionId
        });

        const res = await fetch(`${ROOT_URL}/api/?${queryParams.toString()}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
            "x-requested-with": "XMLHttpRequest"
          },
          body: new URLSearchParams({
            ao: "1",
            op: "get_checkout_cart_info",
            api_key: API_KEY,
            purchased_pids: JSON.stringify(purchasedPids),
            newmycart: JSON.stringify(newMyCart)
          })
        });

        const data = await res.json();
        if (data.status === 1) {
          console.log("✅ Checkout success:", data);
          
          // 🧾 render data checkout ke UI
          renderCheckoutPage(data);
          
          showPage("page-checkout");

          // 🧹 bersihkan cart setelah checkout
          // cart.clear();
          // localStorage.removeItem("cart");

          renderCart();
        } else {
          alert("❌ Checkout failed: " + (data.msg || "Unknown error"));
        }
      } catch (err) {
        console.error(err);
        alert("🚨 Checkout request failed!");
      }
    }

    function renderCheckoutPage(data) {
      const subtotal = parseFloat(data.data.products_subtotal || 0);
      const shipping = parseFloat(data.data.shipping_fee || 0);
      const taxPercent = parseFloat(data.data.tax_percent || 0);
      const tax = subtotal * taxPercent;
      const total = subtotal + shipping + tax;

      // 💰 Update ringkasan harga
      document.getElementById("chkSubtotal").textContent = `RM ${subtotal.toFixed(2)}`;
      document.getElementById("chkDelivery").textContent = shipping > 0 ? `RM ${shipping}` : "Free";
      document.getElementById("chkTax").textContent = `RM ${tax.toFixed(2)}`;
      document.getElementById("chkTotal").textContent = `RM ${total.toFixed(2)}`;

      // 🏠 Update alamat pengiriman
      const shippingInfo = data.data.shipping_info;
      const addressEl = document.getElementById("checkoutAddress");
      addressEl.innerHTML = `
        ${shippingInfo.address1}<br>
        ${shippingInfo.city}, ${data.data.shipping_info_states[shippingInfo.state].state}<br>
        ${data.data.countries[shippingInfo.country].country}
      `;
      
      // 🛍️ Render daftar produk di checkout
      const productListEl = document.getElementById("checkoutProductList");
      productListEl.innerHTML = "";
      const products = data.data.products;
      const disallowed = data.data.disallow_purchase_items || [];

      Object.values(products).forEach(prod => {
        const disabled = disallowed.includes(prod.id);
        const row = document.createElement("div");
        row.className = "row";
        row.style.opacity = disabled ? "0.5" : "1";
        row.innerHTML = `
          <div class="pic"></div>
          <div class="meta">
            <div class="name">${prod.title}</div>
            <div class="label">RM ${prod.price}</div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            ${disabled ? `<div class="chip" style="background:#ff5a5f;">Not Available</div>` 
                      : `<div class="chip">Available</div>`}
            ${disabled ? `<button class="remove-btn" style="border:0;background:none;color:#ff5a5f;font-size:18px;cursor:pointer;">✖</button>` : ""}
          </div>
        `;

        // 🧹 Tambahkan event untuk hapus jika disable
        if (disabled) {
          row.querySelector(".remove-btn").addEventListener("click", () => {
            removeFromCart(prod.id);
            row.remove(); // hapus elemen dari tampilan
            renderCart(); // update subtotal, total, dll
          });
        }

        productListEl.appendChild(row);
      });
    }
  </script>
</body>

</html>
